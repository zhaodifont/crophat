<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>一键圣诞帽</title>
        <meta name="description" itemprop="description" content="转发就会有小仙女给你戴上一顶圣诞帽哦~你们也来试试吧！" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <link rel="stylesheet" type="text/css" href="static/css/global.css" />
        <link rel="stylesheet" type="text/css" href="static/css/main.css?v=10" />
    </head>
    <body>
    <img src="static/img/icon-sdm1.png" style="height:0;overflow: hidden;" alt="">
    <input id="uploadInput" class="invisible" style="position:absolute;left:-999rem;" type="file" accept="image/*" />
        <div id="loadingSection" class="wrapper-inner loading-section" style="width: 100%; left: 0px; display: none;">
                <div class="body">
                    <img class="animate" src="http://res.tu.qq.com/assets/opchristmas2015_img/icon-loading.png">
                    <p>加载中请稍候</p>
                    <div style="display: none;">关闭</div>
                </div>
            </div>

            <div id="qrcodeSection" class="wrapper-inner qrcode-section" style="display: none;width: 100%;left: 0px;">
                <div class="background">&nbsp;</div>
                <div class="body">
                    <img id="qrcodeImg">
                    <p>请使用手机扫码体验</p>
                </div>
            </div>
            <div id="resultSection" class="wrapper-inner result-section" style="text-align: center;margin-top: 10%;">
                <img src="static/img/baby.jpg" alt="" style="width:80%">
                <button  class="choose-btn" style="display:block;height:46px;line-height:46px;border:none;border-radius: 30px;font-size:18px;color:blue;letter-spacing: 1px;">点我定制圣诞头像</button>

            </div>
        <div id="cropSection" class="wrapper-inner crop-section">
                <div id="cropLayer" class="crop-layer">
                    <canvas style="position:absolute;left:-999rem;" id="cropCanvas" width="420" height="420"></canvas>
                    <img id="cropImg" style="display:none;" />
                    <div class="background">&nbsp;</div>
                </div>
                <div id="cropMaskUp" class="crop-mask" style="visibility:hidden;">&nbsp;</div>
                <div id="cropMaskDown" class="crop-mask" style="visibility:hidden;">&nbsp;</div>
                <div id="cropBar" class="crop-bar">
                    <div class="choose-btn">重新选图</div>
                    <div class="next-btn">下一步</div>
                </div>
            </div>

            <div id="hatSection" class="wrapper-inner hat-section">
                <div id="hatLayer" class="hat-layer">
                    <img id="hatFace" />
                    <div class="background">&nbsp;</div>
                    <div id="hatStamp" class="hat-stamp-on" style="left:0;top:0;" scale="1.0" rotation="0">
                        <img class="hat-icon" src="static/img/icon-sdm1.png" />
                        <div class="background">&nbsp;</div>
                        <div class="hat-anchor-ld" anchor="1" style="background-image:url(http://res.tu.qq.com/assets/opchristmas2015_img/icon-anchor.png);">&nbsp;</div>
                        <div class="hat-anchor-rd" anchor="1" style="background-image:url(http://res.tu.qq.com/assets/opchristmas2015_img/icon-anchor.png);">&nbsp;</div>
                    </div>
                </div>
                <div id="hatMaskUp" class="hat-mask" style="visibility:hidden;">&nbsp;</div>
                <div id="hatMaskDown" class="hat-mask" style="visibility:hidden;">&nbsp;</div>
                <div class="choose-download" onclick="javascript:window.location = 'http://tu.qq.com/downloading.php?by=58';">
                  <img src="//res.tu.qq.com/assets/opchristmas2015_img/sdm_download.png" />
                </div>
                <div class="choose-hats">
                  <img id="sdm1" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_1.png" />
                  <img id="sdm2" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_2.png" />
                  <!-- <img id="sdm3" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_3_2.png" /> -->
                  <!-- <img id="sdm4" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_4.png" /> -->
                  <!-- <img id="sdm5" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_5.png" /> -->
                </div>
                <div id="hatBar" class="hat-bar">
                    <!-- <div class="move-tips">移动圣诞帽到恰当位置</div> -->
                    <div class="confirm-btn">确定</div>
                </div>
            </div>
            <div id="saveSection" class="wrapper-inner save-section" style="background:red;display:none;">
                <div class="share-img">
                    <img id="shareImg" />
                    <div class="save-tips">长按可保存头像</div>
                </div>

            </div>

            <br/>

        <!-- <div class="choose-hats">
          <img id="sdm1" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_1.png" style="">
          <img id="sdm2" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_2.png">
          <img id="sdm3" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_3_2.png">
          <img id="sdm4" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_4.png">
          <img id="sdm5" onclick="javascript:chooseHat(this.id);" src="http://res.tu.qq.com/assets/opchristmas2015_img/sdm_5.png" style="border: 2px solid rgb(208, 208, 208);">
        </div> -->

        <script type="text/javascript">
            function loadScript(filepath, onloadCallback) {
                var scriptDom = document.createElement("script");
                scriptDom.onload = scriptDom.onreadystatechange = onloadCallback;
                scriptDom.type = "text/javascript";
                scriptDom.src = filepath;
                document.body.appendChild(scriptDom);
            }

            var zeptoScriptLoaded = false;
            var extScriptLoaded = false;
            var globalScriptLoaded = false;
            var mainScriptLoaded = false;
            var scriptAllLoaded = false;
            function scriptLoadFinish() {
                // if (!scriptAllLoaded && zeptoScriptLoaded && extScriptLoaded && globalScriptLoaded && mainScriptLoaded) {
                //     scriptAllLoaded = true;
                //     window.setTimeout(function(){
                //         pageReady(indexPageReady, indexPageResize);
                //     }, 0);
                // }
                if (!scriptAllLoaded && zeptoScriptLoaded && globalScriptLoaded  && extScriptLoaded) {
                    scriptAllLoaded = true;
                    window.setTimeout(function(){
                        pageReady(indexPageReady)
                    }, 0);
                }
            }
            loadScript("static/js/zepto.min.js", function(){
                if (!zeptoScriptLoaded && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete")) {
                    zeptoScriptLoaded = true;
                    window.setTimeout(scriptLoadFinish, 0);
                }
            });
            loadScript("static/js/ext.js", function(){
                if (!extScriptLoaded && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete")) {
                    extScriptLoaded = true;
                    window.setTimeout(scriptLoadFinish, 0);
                }
            });
            loadScript("static/js/global.js?v=8", function(){
                if (!globalScriptLoaded && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete")) {
                    globalScriptLoaded = true;
                    window.setTimeout(scriptLoadFinish, 0);
                }
            });

function hatConfirm(evt) {
    var $hatStamp = $("#hatStamp");
    var hatStampTransform = $hatStamp.css("-webkit-transform");
    $hatStamp.css("transform", "");
    $hatStamp.css("-webkit-transform", "");
    var hatStampOffset = $hatStamp.find("img").offset();
    $hatStamp.css("transform", hatStampTransform);
    $hatStamp.css("-webkit-transform", hatStampTransform);
    var hatLayerOffset = $("#hatLayer").offset();
    var hatStampFrame = {
        x: (hatStampOffset.left - hatLayerOffset.left + hatStampOffset.width * 0.5) / hatLayerOffset.width,
        y: (hatStampOffset.top - hatLayerOffset.top + hatStampOffset.height * 0.5) / hatLayerOffset.height,
        width: hatStampOffset.width * parseFloat($hatStamp.attr("scale")) / hatLayerOffset.width,
        height: hatStampOffset.height * parseFloat($hatStamp.attr("scale")) / hatLayerOffset.height,
        rotation: parseFloat($hatStamp.attr("rotation"))
    };
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasDom.width, canvasDom.height);
    canvasCtx.drawImage($("#hatFace")[0], 0, 0, canvasDom.width, canvasDom.height);
    canvasCtx.translate(hatStampFrame.x * canvasDom.width, hatStampFrame.y * canvasDom.height);
    canvasCtx.rotate(hatStampFrame.rotation);
    canvasCtx.drawImage($hatStamp.find("img")[0], -hatStampFrame.width * canvasDom.width * 0.5, -hatStampFrame.height * canvasDom.height * 0.5, hatStampFrame.width * canvasDom.width, hatStampFrame.height * canvasDom.height);
    canvasCtx.restore();
    var dataURL = "";
    if (window.isAndroid) {
        var imgEncoder = new JPEGEncoder();
        dataURL = imgEncoder.encode(canvasCtx.getImageData(0, 0, canvasDom.width, canvasDom.height), 100, true);
    } else {
        console.log("not isAndroid");
        dataURL = canvasDom.toDataURL("image/jpeg", 1);
        // console.log(dataURL);

    }
    var dataComponent = dataURL.split(",");
    $("#shareImg").attr("src", dataComponent);
    $("#hatSection").data("result", dataComponent);
    hatConfirmOther();
    // if (dataComponent.length >= 2) {
    //     console.log("dataComponent.length >= 2");
    //     var dataBase64 = dataComponent[1];
    //     if (dataBase64.length > 0) {
    //         $("#hatSection").data("result", dataBase64);
    //         $("#hatStamp")[0].className = "hat-stamp-off";
    //         if ((window.isInMqzone || !window.supportTouch) && window.p_uin.length > 0 && window.p_skey.length > 0) {
    //             hatConfirmQZone();
    //         } else {
    //             hatConfirmOther();
    //         }
    //     }
    // }
    return preventEventPropagation(evt);
}

function hatConfirmOther() {
    // loadingStart("圣诞头像生成中");
    var imgData = $("#hatSection").data("result");
    // var uploadUrl = "http://h5.qzone.qq.com/q/tu/cgi/doStoreImageV5.php";


    // $("#shareImg").attr("src", imgData);

    // $("#hatSection").css("display", "none");
        var photoImg = new Image();
        photoImg.onload = function () {
            // $("#shareImg").attr("src", imgData);
            $("#saveSection .setupwx-tips").css("display", "");
            $("#saveSection").css("display", "");
        }
        photoImg.src = imgData;
    // $.ajax({
    //     url: uploadUrl,
    //     type: "POST",
    //     data: imgData,
    //     dataType: "json",
    //     timeout: 30000,
    //     success: function (data, textStatus) {
    //         if (data.ret == 0) {
    //             $("#saveSection .retry-btn").data("cosid", data.id);
    //             var photoImg = new Image();
    //             photoImg.onload = function () {
    //                 loadingStop();
    //                 $("#shareImg").attr("src", data.url);
    //                 if (window.isInWechat) {
    //                     $("#saveSection .setupqz-tips").css("display", "none");
    //                     $("#saveSection .setupwx-tips").css("display", "");
    //                 } else if (window.isInMqzone || !window.supportTouch) {
    //                     $("#saveSection .save-tips").css("display", "none");
    //                     $("#saveSection .qzcache-tips").css("display", "");
    //                 }
    //                 $("#saveSection").css("display", "");
    //                 $("#hatSection").css("display", "none");
    //                 var shareUrl = window.baseUrl + "index.html?id=" + data.id;
    //                 setShareParams(data.url, shareUrl);
    //             }
    //             photoImg.src = data.url;
    //         } else {
    //             alert("生成失败(" + data.ret + ")", true);
    //             $("#hatStamp")[0].className = "hat-stamp-on";
    //         }
    //     }, error: function (req, errorType, error) {
    //         alert("生成失败(" + errorType + ")", true);
    //         $("#hatStamp")[0].className = "hat-stamp-on";
    //     }
    // });
    return false;
}

function hatTouchStart(evt) {
    var touches = evt.touches || evt.originalEvent.touches;
    var touch = touches[0];
    var offset = {
        "x": touch.pageX,
        "y": touch.pageY
    };
    hatDragStart(offset, touch.target);
    return preventEventPropagation(evt);
}

function hatTouchMove(evt) {
    var touches = evt.touches || evt.originalEvent.touches;
    var touch = touches[0];
    var offset = {
        "x": touch.pageX,
        "y": touch.pageY
    };
    hatDragMove(offset);
    return preventEventPropagation(evt);
}

function hatTouchEnd(evt) {
    hatDragEnd();
    return preventEventPropagation(evt);
}

function hatMouseDown(evt) {
    var offset = {
        "x": evt.pageX,
        "y": evt.pageY
    };
    hatDragStart(offset, evt.srcElement);
    return preventEventPropagation(evt);
}

function hatMouseMove(evt) {
    var offset = {
        "x": evt.pageX,
        "y": evt.pageY
    };
    hatDragMove(offset);
    return preventEventPropagation(evt);
}

function hatMouseUp(evt) {
    hatDragEnd();
    return preventEventPropagation(evt);
}
var hatMode = null;
var hatOrigin = {};
var hatFrom = {};

function indexCropChoose(evt) {
    cropChoose();
}

function resultCropChoose(evt) {
    cropChoose();
}

function cropCropStart() {
    cropStart();
}

//  裁剪系列
function cropChoose(evt) {
    // cropStart();

    if (window.isInWechat) {

        var wxHeadImgUrl = pageGetCookie("ttpt-wxheadimgurl");
        if (wxHeadImgUrl) {
            loadingStart("");
            $.get("api/getHeadIcon.php?url=" + encodeURIComponent(wxHeadImgUrl), function (data, status, xhr) {
                if (status == "success" && data.length > 0) {
                    var photoImg = new Image();
                    photoImg.onload = function () {
                        cropLoaded(this);
                    }
                    photoImg.src = "data:image/jpeg;base64," + data;
                } else {
                    cropStart();
                }
            });
        } else {
            var wxState = pageGetParam("state");
            if (wxState) {
                cropStart();
            } else {
                // alert(0)
                // authorizeByWechatRecirect();
            }
        }
    } else if ((window.isInMqzone || !window.supportTouch) && window.p_uin.length > 0 && window.p_skey.length > 0) {
        console.log('23333');
        loadingStart("");
        $.get("api/getHeadIcon.php", function (data, status, xhr) {
            if (status == "success" && data.length > 0) {
                var photoImg = new Image();
                photoImg.onload = function () {
                    cropLoaded(this);
                }
                photoImg.src = "data:image/jpeg;base64," + data;
            } else {
                cropStart();
            }
        });
    } else {

        cropStart();
    }
    return preventEventPropagation(evt);
}

// 第二页
function cropLoaded(img) {
    console.log("cropLoaded");
    var isSupportTouch = window.supportTouch;
    $("#cropSection").css("display", "");
    var $cropLayer = $("#cropLayer");
    var cropSectionHeight = $("#cropSection").height();
    var cropBarHeight = $("#cropBar").height();
    var cropLayerHeight = $cropLayer.height();
    var cropLayerOriginY = (cropSectionHeight - cropBarHeight - cropLayerHeight) * 0.5;
    $cropLayer.css("top", [cropLayerOriginY * 100 / cropSectionHeight, "%"].join(""));
    $("#cropMaskUp").css("height", [cropLayerOriginY * 100 / cropSectionHeight, "%"].join(""));
    $("#cropMaskUp").css("top", 0);
    $("#cropMaskUp").css("visibility", "visible");
    $("#cropMaskDown").css("height", [cropLayerOriginY * 100 / cropSectionHeight, "%"].join(""));
    $("#cropMaskDown").css("top", [(cropLayerOriginY + cropLayerHeight) * 100 / cropSectionHeight, "%"].join(""));
    $("#cropMaskDown").css("visibility", "visible");
    var imgWidth = img.width;
    var imgHeight = img.height;
    var ratioWidth = $cropLayer.width() / imgWidth;
    var ratioHeight = $cropLayer.height() / imgHeight;
    var ratio = ratioWidth > ratioHeight ? ratioWidth : ratioHeight;
    cropGesture.targetMinWidth = imgWidth * ratio;
    cropGesture.targetMinHeight = imgHeight * ratio;
    var imgOriginX = ($cropLayer.width() - cropGesture.targetMinWidth) * 0.5;
    var imgOriginY = ($cropLayer.height() - cropGesture.targetMinHeight) * 0.5;
    var $cropImg = $("#cropImg");
    $cropImg.css("display", "");
    $cropImg.width(cropGesture.targetMinWidth);
    $cropImg.height(cropGesture.targetMinHeight);
    $cropImg.css("left", [imgOriginX, "px"].join(""));
    $cropImg.css("top", [imgOriginY, "px"].join(""));
    $cropImg[0].src = img.src;
    cropGesture.unbindEvents();
    cropGesture.bindEvents();
    $("#cropBar .choose-btn").unbind(isSupportTouch ? "touchend" : "click");
    $("#cropBar .choose-btn").on(isSupportTouch ? "touchend" : "click", cropCropStart);
    $("#cropBar .next-btn").unbind(isSupportTouch ? "touchend" : "click");
    $("#cropBar .next-btn").on(isSupportTouch ? "touchend" : "click", cropConfirm);
    return false;
}

function cropStart(evt) {
    var $upload = $("#uploadInput");
    $upload.unbind("change");
    $upload.one("change", cropChanged);
    $upload.trigger("click");
    // if (window.isInMqq && window.self != window.top) {
    //     var followObj = {
    //         postcode: 'follow',
    //         data: {}
    //     }
    //     window.parent.postMessage(followObj, '*');
    // }
    return preventEventPropagation(evt);
}

function cropStop(evt) {
    var isSupportTouch = window.supportTouch;
    cropGesture.unbindEvents();
    $("#cropBar .choose-btn").unbind(isSupportTouch ? "touchend" : "click");
    $("#cropBar .next-btn").unbind(isSupportTouch ? "touchend" : "click");
    $("#cropSection").css("display", "none");
    $("#cropMaskUp").css("visibility", "hidden");
    $("#cropMaskDown").css("visibility", "hidden");
    $("#cropImg").css("display", "none");
    $("#cropImg").attr("src", "");
    $("#uploadInput").unbind("change");
    return preventEventPropagation(evt);
}

function cropChanged(evt) {
    console.log(1111);
    if (this.files.length <= 0) {
        cropStop();
        return preventEventPropagation(evt);
    }
    $("#cropSection").css("display", "");
    var file = this.files[0];
    var reader = new FileReader();
    reader.onload = function () {
        var binary = this.result;
        var binaryData = new BinaryFile(binary);
        var imgExif = EXIF.readFromBinaryFile(binaryData);
        var fullScreenImg = new Image();
        fullScreenImg.onload = function () {
            cropLoaded(this);
        }
        var mpImg = new MegaPixImage(file);
        mpImg.render(fullScreenImg, {
            maxWidth: 960,
            maxHeight: 960,
            orientation: imgExif.Orientation
        });
    }
    reader.readAsBinaryString(file);
    return preventEventPropagation(evt);
}

//
function cropConfirm(evt) {
    pageRecordClick("sng.tu.christmas2015.nextbtn");
    var canvasScale = canvasDom.height / $("#cropLayer").height();
    var $cropImg = $("#cropImg");
    var imgOrigin = {
        x: parseInt($cropImg.css("left")) || 0,
        y: parseInt($cropImg.css("top")) || 0
    };
    var imgSize = {
        width: $cropImg.width(),
        height: $cropImg.height()
    };
    canvasCtx.clearRect(0, 0, canvasDom.width, canvasDom.height);
    canvasCtx.drawImage($cropImg[0], imgOrigin.x * canvasScale, imgOrigin.y * canvasScale, imgSize.width * canvasScale, imgSize.height * canvasScale);
    var dataURL = "";
    if (window.isAndroid) {
        var imgEncoder = new JPEGEncoder();
        dataURL = imgEncoder.encode(canvasCtx.getImageData(0, 0, canvasDom.width, canvasDom.height), 100, true);
    } else {
        dataURL = canvasDom.toDataURL("image/jpeg", 1.0);
    }
    var dataComponent = dataURL.split(",");
    if (dataComponent.length >= 2) {
        var dataBase64 = dataComponent[1];
        if (dataBase64.length > 0) {
            cropStop();
            hatStart(dataBase64);
        }
    }
    return preventEventPropagation(evt);
}

function hatDragStart(pos, tgt) {
    var $hatStamp = $("#hatStamp");
    var hatStampTransform = $hatStamp.css("-webkit-transform");
    $hatStamp.css("transform", "");
    $hatStamp.css("-webkit-transform", "");
    var hatStampOrigin = $hatStamp.offset();
    $hatStamp.css("transform", hatStampTransform);
    $hatStamp.css("-webkit-transform", hatStampTransform);
    var hatLayerOrigin = $("#hatLayer").offset();
    if ($(tgt).attr("anchor") == "1") {
        hatMode = "anchor";
        hatOrigin = {
            x: hatStampOrigin.left - hatLayerOrigin.left + hatStampOrigin.width * 0.5,
            y: hatStampOrigin.top - hatLayerOrigin.top + hatStampOrigin.height * 0.5,
            scale: parseFloat($hatStamp.attr("scale")),
            rotation: parseFloat($hatStamp.attr("rotation"))
        };
        hatFrom = {
            x: pos.x - hatLayerOrigin.left - hatOrigin.x,
            y: pos.y - hatLayerOrigin.top - hatOrigin.y
        };
    } else {
        hatMode = "drag";
        hatOrigin = {
            x: hatStampOrigin.left - hatLayerOrigin.left,
            y: hatStampOrigin.top - hatLayerOrigin.top
        };
        hatFrom = pos;
    }
}

function hatDragMove(pos) {
    var $hatStamp = $("#hatStamp");
    if (hatMode == "anchor") {
        var hatLayerOrigin = $("#hatLayer").offset();
        var hatTo = {
            x: pos.x - hatLayerOrigin.left - hatOrigin.x,
            y: pos.y - hatLayerOrigin.top - hatOrigin.y
        };
        var distanceFrom = distanceBetweenPoints({
            x: 0,
            y: 0
        }, hatFrom);
        var distanceTo = distanceBetweenPoints({
            x: 0,
            y: 0
        }, hatTo);
        var scale = hatOrigin.scale * distanceTo / distanceFrom;
        var rotationFrom = angleBetweenPoints({
            x: 0,
            y: 0
        }, hatFrom);
        var rotationTo = angleBetweenPoints({
            x: 0,
            y: 0
        }, hatTo);
        var rotation = hatOrigin.rotation + rotationTo - rotationFrom;
        var degree = rotation * 180 / Math.PI;
        $hatStamp.attr("scale", scale);
        $hatStamp.attr("rotation", rotation);
        $hatStamp.css("transform", "scale(" + scale + ") rotate(" + degree + "deg)");
        $hatStamp.css("-webkit-transform", "scale(" + scale + ") rotate(" + degree + "deg)");
    } else if (hatMode == "drag") {
        var offset = {
            x: pos.x - hatFrom.x,
            y: pos.y - hatFrom.y
        };
        var current = {
            x: hatOrigin.x + offset.x,
            y: hatOrigin.y + offset.y
        };
        $hatStamp.css("left", [current.x, "px"].join(""));
        $hatStamp.css("top", [current.y, "px"].join(""));
    }
}

function hatDragEnd() {
    hatMode = null;
}

function pageReadya(){
cropStart();


var canvasDom;
var canvasCtx;
var cropGesture = null;

indexPageReady();








}


function indexPageReady() {

    var cosid = pageGetParam("id");
    document.getElementById("loadingSection").style.display = "none";

    // if (!window.supportTouch && !window.isWebkit) {
    //     var pageUrl = window.baseUrl + "index.html?id=" + cosid;
    //     var qrcodeUrl = "http://test.tu.qq.com/websites/qrcode.php?url=" + encodeURIComponent(pageUrl);
    //     document.getElementById("qrcodeImg").src = qrcodeUrl;
    //     document.getElementById("qrcodeSection").style.display = "";
    //     return;
    // }

    if (window.isInWechat) {
        $("#saveSection .share-btn").css("display", "none");
    }
    window.p_uin = pageGetCookie("uin").replace(/o/, "");
    window.p_skey = pageGetCookie("p_skey");
    var shouldSetDefaultShareParams = true;
    var wxState = pageGetParam("state");

    var wxHeadImgUrl = pageGetParam("wxheadimgurl") || pageGetCookie("ttpt-wxheadimgurl");

    if (window.isInWechat && wxState && wxHeadImgUrl.length > 0) {
        loadingStart("");
        $.get("api/getHeadIcon.php?url=" + encodeURIComponent(wxHeadImgUrl), function (data, status, xhr) {
            if (status == "success" && data.length > 0) {
                var photoImg = new Image();
                photoImg.onload = function () {
                    cropLoaded(this);
                    $("#welcomeSection").css("display", "");
                }
                photoImg.src = "data:image/jpeg;base64," + data;
            } else {
                $("#welcomeSection").css("display", "");
            }
        });
    } else {
        if (cosid.length > 0) {
            shouldSetDefaultShareParams = false;
            loadingStart("");
            var cgiUrl = "../../cgi/queryCosInfo.php?id=" + cosid;
            $.getJSON(cgiUrl, function (data, status, xhr) {
                if (status == "success") {
                    var photoImg = new Image();
                    photoImg.onload = function () {
                        $("#resultImg").attr("src", this.src);
                        $("#resultSection").css("display", "");
                    };
                    photoImg.src = data.rawPhotoUrl;
                    var shareUrl = window.baseUrl + "index.html?id=" + cosid;
                    setShareParams(data.rawPhotoUrl, shareUrl);
                } else {
                    $("#welcomeSection").css("display", "");
                    var shareImg = $("#defaultImg").attr("src");
                    var shareUrl = window.baseUrl + "index.html?id=" + cosid;
                    setShareParams(shareImg, shareUrl);
                }
            });
        } else {
            if (window.isInMqzone && window.p_uin.length > 0 && window.p_skey.length > 0) {
                loadingStart("");
                $.get("api/getHeadIcon.php", function (data, status, xhr) {
                    if (status == "success" && data.length > 0) {
                        var photoImg = new Image();
                        photoImg.onload = function () {
                            cropLoaded(this);
                            $("#welcomeSection").css("display", "");
                        }
                        photoImg.src = "data:image/jpeg;base64," + data;
                    } else {
                        $("#welcomeSection").css("display", "");
                    }
                });
            } else {
                $("#welcomeSection").css("display", "");
            }
        }
    }
console.log(44444);
    window.setTimeout(function () {
        $("#welcomeSection .choose-btn").on("click", indexCropChoose);
        $("#resultSection .choose-btn").on("click", resultCropChoose);

        cropGesture = new EZGesture($("#cropLayer")[0], $("#cropImg")[0], {
            targetMinWidth: 420,
            targetMinHeight: 420
        });
        var $canvas = $("#cropCanvas");
        canvasDom = $canvas[0];
        canvasCtx = canvasDom.getContext("2d");
        cropGesture.targetMinWidth = canvasDom.width;
        cropGesture.targetMinHeight = canvasDom.height;
        $("#cropSection").css("visibility", "hidden");
        $("#cropSection").css("display", "");
        var cropLayerHeight = ($("#cropSection").width() * canvasDom.height * 100 / (canvasDom.width * $("#cropSection").height())).toFixed(2);
        $("#cropLayer").css("height", [cropLayerHeight, "%"].join(""));
        $("#cropSection").css("display", "none");
        $("#cropSection").css("visibility", "visible");
        var $hatSection = $("#hatSection");
        var $hatLayer = $("#hatLayer");
        $hatSection.css("visibility", "hidden");
        $hatSection.css("display", "");
        var hatLayerHeight = ($hatSection.width() * canvasDom.height * 100 / (canvasDom.width * $hatSection.height())).toFixed(2);
        $hatLayer.css("height", [hatLayerHeight, "%"].join(""));
        $hatSection.css("display", "none");
        $hatSection.css("visibility", "visible");
        if ((window.isInMqzone || !window.supportTouch) && window.p_uin.length > 0 && window.p_skey.length > 0) {
            $("#hatSection .confirm-btn").text("设为空间头像");
        }
        $("#hatSection .confirm-btn").on("click", hatConfirm);
        if (window.supportTouch) {
            $hatLayer.on("touchstart", hatTouchStart);
            $hatLayer.on("touchmove", hatTouchMove);
            $hatLayer.on("touchend", hatTouchEnd);
        } else {
            $hatLayer.on("mousedown", hatMouseDown);
            $hatLayer.on("mousemove", hatMouseMove);
            $hatLayer.on("mouseup", hatMouseUp);
        }
        // $("#saveSection .share-btn").on("click", sharePageByPlatform);
        // $("#saveSection .retry-btn").on("click", retryButtonPressed);
        $("#saveSection .download-btn").on("click", function () {
            pageRecordClick("sng.tu.christmas2015.downloadbtn");
            window.location = "http://tu.qq.com/downloading.php?by=58";
        });
        $("#shareSection").on("click", function () {
            $("#shareSection").css("display", "none");
        });
        if (shouldSetDefaultShareParams) {
            var shareImg = $("#defaultImg").attr("src");
            var shareUrl = window.baseUrl + "index.html";
            // setShareParams(shareImg, shareUrl);
        }
        var pf_flag = "other";
        if (window.isInWechat) {
            pf_flag = "wechat";
        } else if (window.isInMqzone) {
            pf_flag = "mqzone";
        } else if (window.isInMqq) {
            pf_flag = "mqq";
        }
        pageRecordPV(location.pathname + "-" + pf_flag);
    }, 0);
}

var gHatId = "sdm1";
function hatStart(imgData) {
    $("#hatFace").attr("src", "data:image/jpeg;base64," + imgData);
    $("#" + gHatId).css("border", "2px solid #f80051");
    $("#hatStamp")[0].className = "hat-stamp-on";
    $("#hatSection").css("display", "");
    var $hatLayer = $("#hatLayer");
    var hatSectionHeight = $("#hatSection").height();
    var hatBarHeight = $("#hatBar").height();
    var hatLayerHeight = $hatLayer.height();
    var hatLayerOriginY = (hatSectionHeight - hatBarHeight - hatLayerHeight) * 0.01;
    $hatLayer.css("top", [hatLayerOriginY * 100 / hatSectionHeight, "%"].join(""));
    $("#hatMaskUp").css("height", [hatLayerOriginY * 100 / hatSectionHeight, "%"].join(""));
    $("#hatMaskUp").css("top", 0);
    $("#hatMaskUp").css("visibility", "visible");
    $("#hatMaskDown").css("height", [hatLayerOriginY * 100 / hatSectionHeight, "%"].join(""));
    $("#hatMaskDown").css("top", [(hatLayerOriginY + hatLayerHeight) * 100 / hatSectionHeight, "%"].join(""));
    $("#hatMaskDown").css("visibility", "visible");
    var hatSectionWidth = $("#hatSection").width();
    var hatStampWidth = $("#hatStamp").width();
    $("#hatStamp").css("left", [(hatSectionWidth - hatStampWidth) * 0.5, "px"].join(""));
    $("#hatStamp").css("top", "0px");
}

function chooseHat(id) {
    // pageRecordClick("sng.tu.christmas2015." + id);
    $("#" + gHatId).css("border", "");
    if (id == "sdm1" || id == "sdm2") {
        $("#hatSection .choose-download").css("display", "none");
        $("#" + id).css("border", "2px solid #f80051");
        $("#hatStamp .hat-icon").attr("src", "static/img/icon-" + id + ".png");
    } else {
        $("#" + id).css("border", "2px solid #d0d0d0");
        if (id == "sdm4") {
            $("#hatSection .choose-download").css("left", "48%");
        } else if (id == "sdm5") {
            $("#hatSection .choose-download").css("left", "65%");
        } else {
            $("#hatSection .choose-download").css("left", "32%");
        }
        $("#hatSection .choose-download").css("display", "block");
    }
    gHatId = id;
}


        </script>
    </body>


</html>
